* template.rb has to be rewrtten. See Cherry's (javascript version) of code and
  reimplement identically.

